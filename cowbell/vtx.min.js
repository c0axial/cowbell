(function(){var h=function(a){this.buffer=a;this.offset=0;this.subOffset=7};h.SeekAbsolute=0;h.SeekRelative=1;h.prototype.readBits=function(a){for(var b=[1,2,4,8,16,32,64,128],c=this.buffer[this.offset],e=0,f=0;f<a;f++){var g=(c&b[this.subOffset])>>this.subOffset,e=e<<1,e=e|g;this.subOffset--;if(0>this.subOffset){if(this.offset+1>=this.buffer.length)return-1;c=this.buffer[++this.offset];this.subOffset=7}}return e};h.prototype.readUInt8=function(){return this.offset+1>=this.buffer.length?-1:this.buffer[this.offset++]};
h.prototype.readUInt16=function(){if(this.offset+2>=this.buffer.length)return-1;var a=this.buffer[this.offset]&255|this.buffer[this.offset+1]<<8&65280;this.offset+=2;return a};h.prototype.readUInt32=function(){if(this.offset+4>=this.buffer.length)return-1;var a=this.buffer[this.offset]&255|this.buffer[this.offset+1]<<8&65280|this.buffer[this.offset+2]<<16&16711680|this.buffer[this.offset+3]<<24&4278190080;this.offset+=4;return a};h.prototype.readString=function(a){if(this.offset+a>=this.buffer.length)return-1;
for(var b="",c=0;c<a;c++)b+=String.fromCharCode(this.buffer[this.offset++]);return b};h.prototype.readLength=function(){var a=this.readBits(3);if(-1==a)return-1;if(7==a)for(;0!=this.readBits(1);)a++;return a};h.prototype.seek=function(a,b){switch(b){case h.SeekAbsolute:this.offset=a;this.subOffset=7;break;case h.SeekRelative:this.offset+=a,this.subOffset=7}};h.prototype.getPosition=function(){return this.offset};var n=function(a){this.offset=0;this.size=a;this.data=new Uint8Array(a)};n.prototype.write=
function(a){this.data[this.offset++]=a};var k=function(){};k.LEAF=32768;k.prototype.setConstant=function(a){this.tree[0]=a|k.LEAF};k.prototype.expand=function(){for(var a=this.allocated;this.nextEntry<a;)this.tree[this.nextEntry]=this.allocated,this.allocated+=2,this.nextEntry++};k.prototype.addCodesWithLength=function(a,b){for(var c=!0,e=0;e<a.length;e++)if(a[e]==b){var f=this.nextEntry++;this.tree[f]=e|k.LEAF}else a[e]>b&&(c=!1);return c};k.prototype.build=function(a,b){this.tree=[];for(var c=0;c<
b;c++)this.tree[c]=k.LEAF;this.nextEntry=0;this.allocated=1;c=0;do this.expand(),c++;while(!this.addCodesWithLength(a,c))};k.prototype.readCode=function(a){for(var b=this.tree[0];0==(b&k.LEAF);)var c=a.readBits(1),b=this.tree[b+c];return b&~k.LEAF};var d=function(a){this.data=[];this.size=a;this.offset=0};d.prototype.add=function(a){this.data[this.offset]=a;this.offset=(this.offset+1)%this.size};d.prototype.get=function(a,b){for(var c=this.offset+this.size-a-1,e=[],f=0;f<b;f++){var g=this.data[(c+
f)%this.size];e.push(g);this.add(g)}return e};var l=function(a,b){this.reader=a;this.offsetTree=new k;this.codeTree=new k;if("lh4"==b)this.ringBuffer=new d(8192);else if("lh5"==b)this.ringBuffer=new d(16384);else throw"mode must be either lh4 or lh5";};l.prototype.readTempTable=function(){var a=this.reader,b=Math.min(a.readBits(5),19);if(0>=b)a=a.readBits(5),this.offsetTree.setConstant(a);else{for(var c=[],e=0;e<b;e++){var f=a.readLength();c.push(f);if(2==e)for(f=a.readBits(2);0<f--;)c.push(0),e++}this.offsetTree.build(c,
38)}};l.prototype.readCodeTable=function(){var a=this.reader,b=Math.min(a.readBits(9),510);if(0>=b)a=a.readBits(9),this.codeTree.setConstant(a);else{for(var c=[],e=0;e<b;){var f=this.offsetTree.readCode(a);if(2>=f){var g=1;for(1==f?g=a.readBits(4)+3:2==f&&(g=a.readBits(9)+20);0<=--g;)c.push(0),e++}else c.push(f-2),e++}this.codeTree.build(c,1020)}};l.prototype.readOffsetTable=function(){var a=this.reader,b=Math.min(a.readBits(4),14);if(0>=b)a=a.readBits(4),this.offsetTree.setConstant(a);else{for(var c=
[],e=0;e<b;e++){var f=a.readLength();c[e]=f}this.offsetTree.build(c,38)}};l.prototype.extract=function(a,b,c,e){function f(){d.extractBlock(g)&&(c&&c(g.offset,g.size),g.offset>=g.size||setTimeout(f,1))}this.reader.seek(a,h.SeekAbsolute);var g=new n(b),d=this;setTimeout(f,1);return g.data};l.prototype.extractBlock=function(a){var b=this.reader,c=b.readBits(16);if(0>=c||b.offset>=b.size)return!1;this.readTempTable();this.readCodeTable();this.readOffsetTable();for(var e=0;e<c;e++){var f=this.codeTree.readCode(b);
if(256>f)this.ringBuffer.add(f),a.write(f);else{var d=this.offsetTree.readCode(b),h=d;2<=d&&(h=b.readBits(d-1),h+=1<<d-1);var f=this.ringBuffer.get(h,f-256+3),k;for(k in f)a.write(f[k])}}return!0};Cowbell.Common.LhaArrayReader=h;Cowbell.Common.LhaReader=l})();(function(){function h(h,k){return new Cowbell.Common.AYGenerator(h,k,function(d,h){var a=String.fromCharCode.apply(null,d.subarray(0,2));if("ay"!==a&&"ym"!==a)throw"Not a VTX file";for(var b={1:"abc",2:"acb",3:"bac",4:"bca",5:"cab",6:"cba"}[d[2]&7]||"mono",c=d[8]<<24|d[7]<<16|d[6]<<8|d[5],e=d[9],f=d[15]<<24|d[14]<<16|d[13]<<8|d[12],a=16;0!==d[a];)a++;String.fromCharCode.apply(null,d.subarray(16,a));a++;for(var g=a;0!==d[a];)a++;String.fromCharCode.apply(null,d.subarray(g,a));a++;for(g=a;0!==d[a];)a++;
String.fromCharCode.apply(null,d.subarray(g,a));a++;for(g=a;0!==d[a];)a++;String.fromCharCode.apply(null,d.subarray(g,a));a++;for(g=a;0!==d[a];)a++;String.fromCharCode.apply(null,d.subarray(g,a));a++;var k=(new Cowbell.Common.LhaReader(new Cowbell.Common.LhaArrayReader(d),"lh5")).extract(a,f,function(a,d){if(!(a<d)){for(var g=f/14,n=[],s=0,q=0;q<g;q++){for(var m=[],p=0;14>p;p++){var r=k[p*g+q];13>p?m[p]=r:255==r?(m[13]=s,m[14]=!1):(s=m[13]=r,m[14]=!0)}n[q]=m}h({ayRegisterLog:n,ayFrequency:c,commandFrequency:e,
stereoMode:b})}})})}Cowbell.Player.VTX=function(){return new Cowbell.Common.WebAudioPlayer(h)}})();
